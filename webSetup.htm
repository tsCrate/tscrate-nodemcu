<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>WiFi Setup</title>
</head>

<body>
<div class="login-page">
    <div class="form">
          <img src="logo.jpg"><br>
          Enter WiFi your module will connect to:
          <br>
          <br>
          <input id="ssidInput" type="text" placeholder="WiFi Name"/>
          <input id="pwdInput" type="password" placeholder="WiFi Password"/>
          Status: <span id="wifiStatus">No Connection</span>
          <br>
          <br>
          <button id="wifiButton">Connect WiFi</button>
          <br>
          <br>
          <br>
          Enter server and port your module will connect to (default port 8082):
          <br>
          <br>
          <input id="serverInput" type="text" placeholder="Server Address"/>
          <input id="portInput" type="text" placeholder="Port Number" value="8082"/>
          <button id="serverButton">Connect Server</button>
          <span id="passphraseStatus" style="font-size: 1.1em; color:blue;"></span>
    </div>
</div>


<script>
(function() {

  // check status for server and wifi
  var checkInterval = 2000;
  var statusUpdateTimer = setInterval(checkNetworkStatus, checkInterval);
  var wifiStatus = '';
  var passphrase = '';
  let wifiStats = [
    "WiFi Idle",
    "WiFi Connecting",
    "WiFi Wrong Password",
    "WiFi Not Found",
    "WiFi Failed",
    "WiFi Connected"
  ]

  var inputXhr;
  var statusXhr;
  document.getElementById("wifiButton").onclick = function() { makeRequest("wifi"); };
  document.getElementById("serverButton").onclick = function() { makeRequest("server"); };

  function updateStatus() {
    if (statusXhr.readyState === XMLHttpRequest.DONE) {
      if (statusXhr.status === 200) {
        console.log(statusXhr.responseText);
        var msgObj = JSON.parse(statusXhr.responseText);
        if (msgObj != "") {
            passphrase = msgObj.passphraseStatus
            wifiStatusCode = msgObj.wifiStatusCode;
            if (msgObj.wifiStatusCode == 5)
              document.getElementById("serverButton").disabled = false;
            else
              document.getElementById("serverButton").disabled = true;

            document.getElementById("wifiStatus").textContent = wifiStats[msgObj.wifiStatusCode];
            document.getElementById("passphraseStatus").textContent = "Enter passphrase online: " + passphrase;
        }
        else {
            document.getElementById("wifiStatus").textContent = 'Unknown';
        }
      }
    }
  }

  function checkNetworkStatus() {
    statusXhr = new XMLHttpRequest();
    statusXhr.onreadystatechange = updateStatus;
    statusXhr.open("POST", "ajaxReq");
    statusXhr.timeout = 1000;
    let msgObj = new Object();
    msgObj.msgType = 'statusRequest';
    statusXhr.send(JSON.stringify(msgObj) + "\r\n\r\n");
  }

  // TODO update some other field for replies to input
  function handleReponse() {
    if (inputXhr.readyState === XMLHttpRequest.DONE) {
      if (inputXhr.status === 200) {
        document.getElementById("wifiStatus").textContent = 'Sending...';
      } else {
        alert("Ajax HTTP status:" + inputXhr.status + " " + inputXhr.responseText + " Check WiFi connection");
      }
    }
  }

  // send server or wifi data
  function makeRequest(msgType) {
    inputXhr = new XMLHttpRequest();
    if (!inputXhr) {
      alert("Unable to create XMLHTTP instance");
      return false;
    }

    inputXhr.onreadystatechange = handleReponse;
    inputXhr.open("POST", "ajaxReq");

    let msgObj = new Object();
    msgObj.msgType = msgType;
    if (msgType == "wifi") {
        msgObj.ssid = document.getElementById("ssidInput").value
        msgObj.pwd = document.getElementById("pwdInput").value
    }
    else {
        msgObj.serverAddr = document.getElementById("serverInput").value
        msgObj.serverPort = document.getElementById("portInput").value
    }

    inputXhr.send(JSON.stringify(msgObj) + "\r\n\r\n");
  }

})();
</script>

</body>
</html>
